<!-- View for: All -->

{% extends 'base.html' %}
{% load static %}

{% block prehead %}
    <a href="{{request.META.HTTP_REFERER|escape}}" class="flex-btn" style="width: 71px; margin: 27px 0px;"><img src="{% static 'images/icons/LeftArrow.svg' %}"> Back</a>

    {% if jof.status == 1 %}
    <span class="chip semibold bginfo500 margmain"> Pending approval </span>
    {% elif jof.status == 2 %}
    <span class="chip semibold bgwarn500 margmain"> In progress </span>
    {% elif jof.status == 3 %}
    <span class="chip semibold bgerror500 margmain"> Not taken </span>
    {% elif jof.status == 4 %}
    <span class="chip semibold bgsucc600 margmain"> Completed </span>
    {% endif %}

{% endblock %}


{% block title %}{{jof.name}}{% endblock %}
{% block heading %}{{jof.name}}{% endblock %}

{% block content %}

{% if jof.isrush %}
<p class="reg med dgray100">Rush | Blast Date: {{jof.date}}</p>
{% else %}
<p class="reg med dgray100">Standard | Blast Date: {{jof.date}}</p>
{% endif %}

<p class="reg">{{jof.summary|linebreaks}}</p>

{% if jof.status != 4 %}
<h2>Specifications</h2>
<p class="reg med dgray100">Deliverable Type: {{jof.get_type_display}}</p>
<p class="reg med dgray100">Deliverable Pegs: <a href="{{jof.pegs}}">{{jof.pegs}}</a></p>
<p class="reg">{{jof.description|linebreaks}}</p>
{% endif %}

{% if jof.status == 3 %}
    <h2>Spiel</h2>
    {% if jof.spiel %}
    <p class="reg">{{jof.spiel|linebreaks}}</p>
    {% else %}
    <p class="reg error600">No spiel was provided by the client.</p>
    {% endif %}

    {% if account.type == 'Artist' %}
    <a href="{% url 'jofaccept' jof.pk%}"><button class="btn btn-flex primary margmain" style="margin-top: 32px;">Accept</button></a>
    {% endif %}
    
{% else %}
    {% if account == jof.client and drafts.count > 0 and jof.status != 4 %}
    <a href="{% url 'joffinish' jof.pk %}"><button class="btn btn-flex primary" style="margin-top: 16px;">Approve Deliverable</button></a>
    {%endif%}

    {%if jof.status == 4%}
    <div class="fieldrow-flex" style="gap: 16px; margin-bottom: 0px;">
        <a id="downloadbutton" href="" download="final"><button class="btn btn-flex primary">Download Pub</button></a>
        <button id="copybutton" name="" class="btn btn-flex primary" onclick="copySpiel()">Copy Spiel</button>
    </div>
    <script>
        function copySpiel()
        {
            

            const mySmartTextarea = document.createElement('textarea');
            mySmartTextarea.innerHTML = document.getElementById("finalspiel").innerText;
            const parentElement = document.body.appendChild(mySmartTextarea);
            mySmartTextarea.select();
            document.execCommand('copy');
            parentElement.removeChild(mySmartTextarea);
        }
        
    </script>
    {%endif%}

    <!-- Draft Tabs -->
    {% if drafts.count > 0 %}
        <div id="drafts" class="margmain">
            <div class="tab">
                {%for draft in drafts%}
                    <button class="tabbutton sm semibold" onclick="showDraft(event, 'draft{{draft.dnum}}', 'comments{{draft.dnum}}')" id="tabbutton{{draft.dnum}}">Draft #{{draft.dnum}}</button>
                {%endfor%}
            </div>
            {%for draft in drafts%}
                {%if draft.dnum != drafts.count %}
                    <script>
                        var div = document.createElement("div");
                        var spiel = document.createElement("p");
                        spiel.style.width = "648px";
                        spiel.style.wordBreak = "break-word";
                        spiel.style.whiteSpace = "pre-wrap";
                        spiel.innerHTML = `{{draft.spiel}}`;
                        
                        
                        var img = document.createElement('img');
                        img.className+=" pub";
                        img.src = "{{draft.file.url}}";
                        div.id = "draft{{draft.dnum}}"
                        div.append(img, spiel);
                        div.className+=" draftbox deliv";
                        div.style.display = "none";
                        
                        document.getElementById("drafts").append(div);

                        
                        
                    </script>

                {%elif draft.dnum == drafts.count %}
                <script>

                    var div = document.createElement("div");
                    var spiel = document.createElement("p");
                    spiel.style.width = "648px";
                    spiel.style.wordBreak = "break-word";
                    spiel.style.whiteSpace = "pre-wrap";
                    spiel.innerHTML = `{{draft.spiel}}`;
            
                    spiel.id = "finalspiel"
                    
                    var img = document.createElement('img');
                    img.className+=" pub";
                    img.src = "{{draft.file.url}}";
                    div.id = "draft{{draft.dnum}}"
                    div.append(img, spiel);
                    div.className+=" draftbox deliv";
                    div.style.display = "none";
                    
                    document.getElementById("drafts").append(div);

                    document.getElementById("downloadbutton").href = "{{draft.file.url}}";
                    
                </script>

                {%endif%}
            {%endfor%}
        </div>
    {% endif %}
    <script>
        function showDraft(evt, draftId, commentId) {
            
            var i, drafts, buttons, comments;
        
            drafts = document.getElementsByClassName("draftbox");
            for (i = 0; i < drafts.length; i++) {
            drafts[i].style.display = "none";
            }
        
            comments = document.getElementsByClassName("commentbox");
            for (i = 0; i < comments.length; i++) {
            comments[i].style.display = "none";
            }

            buttons = document.getElementsByClassName("tabbutton");
            for (i = 0; i < buttons.length; i++) {
            buttons[i].className = buttons[i].className.replace(" tabactive", "");
            }
        
            
            document.getElementById(draftId).style.display = "flex";
            if(commentId!=null)
            {
            document.getElementById(commentId).style.display = "block";
            
            }
            evt.currentTarget.className += " tabactive";

            if (draftId != "newdraftbox")
            {
                document.getElementById("uploadButton").classList.remove("tabactive");
            }
        }
    </script>

    <!-- Upload -->
    {% if account == jof.artist and drafts.count < 3 and jof.status != 4 %}
    <div id="newdraftbox" class="draftbox margmain" style="display: none">
        <h2>Upload New Draft</h2>
        <form class="fieldcol-flex" method="post" action="{% url 'draftupload' jof.pk %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="field-flex pub">
                <input name="fileinput" type="file" id="id_file" />
            </div>
            <div class="field-flex">
                <label class="label" for="id_spiel">Spiel</label>
                <textarea class="textarea" name="spielinput" style="width: 100%;" id="id_spiel"></textarea>
            </div>
            <input class="btn btn-flex primary" type="submit" name="submit" value="Submit Draft"/>
        </form>
    </div>
    <button class="btn btn-flex primary margmain" style="margin-top: 24px;" onclick="showDraft(event, 'newdraftbox', null)" id="uploadButton">Upload New Draft</button>
    {%endif%}

    <!-- Comments -->
    {%for draft in drafts%}
        <div id="comments{{draft.dnum}}" class="commentbox" style="display:none">
            <h2 style="margin-top: 32px;">Comments</h2>
            {% if comments %}
                <div class="commentset">
                    {% for comment in comments %}
                        {%if comment.draft == draft%}
                            <div class="comment">
                                <p class="reg semibold btn-flex">{{comment.commenter.name}} <span class="xs med dgray100">{{comment.date}}</span></p>
                                <p class="reg" style="word-wrap: break-word;">{{comment.content|linebreaks}}</p>
                            </div>
                        {% else %}
                            {% if forloop.counter == comments.count and jof.status ==  4 %}
                                <p class="reg error600">No comments were made on this draft.</p>
                            {% endif %}
                        {%endif%}
                    {% endfor %}
                </div>
            {% endif %}
            {% if jof.status != 4 %}
            <form method="post" action="{% url 'commentadd' draft.pk %}">
                {% csrf_token %}
                <div class="field-flex" style="margin-top: 32px">
                    <textarea class="textarea" style="width: 100%;" name="commentinput" placeholder="Add a comment..." id="id_comment"></textarea>
                </div>
                <input class="btn btn-flex primary" style="margin: 24px 0px;" type="submit" name="submit" value="Post Comment"/>
            </form>
            {% endif %}
        </div>
        
    {%endfor%}
{% endif %}

<!-- Set default clicked tab -->
{% if drafts.count == 1 %}
    <script>
        document.body.onload = function() {
            
            document.getElementById("tabbutton1").click();
            
            
        }
    </script>
{% elif drafts.count == 2 %}
    <script>
        document.body.onload = function() {
            
            document.getElementById("tabbutton2").click();
            
        }
    </script>
{% elif drafts.count == 3 %}
    <script>
        document.body.onload = function() { 
            
            document.getElementById("tabbutton3").click();
            
        }
    </script>
{% endif %}

{% endblock %}